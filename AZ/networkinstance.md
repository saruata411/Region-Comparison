# ネットワークインスタンスの可用性  

## 目次  

<!-- TOC depthFrom:3 depthTo:3 withLinks:1 updateOnSave:1 orderedList:0 -->

- [1. 仮想ルータ](#1-仮想ルータ)
- [2. ロードバランサー](#2-ロードバランサー)

<!-- /TOC -->


---

### 1. 仮想ルータ


---

#### 旧リージョン

仮想ルータと仮想サーバは異なる物理ホストに配備されるため、仮想ルータ用の物理ホストがシングルポイントになります。  
マルチAZ構成にすることで仮想ルータ用の物理ホストが二重化され、通信不可となるリスクを低減できます。  

![](./images/vrouter_gen1.png)  

- 物理ホストAダウン → 仮想サーバ1・仮想サーバ2ともに通信不可  
- 物理ホストBダウン → 仮想サーバ1のみ影響あり  
- 物理ホストCダウン → 仮想サーバ2のみ影響あり  


---

#### 新リージョン

仮想ルータと仮想サーバは同じ物理ホストに配備されます。  
複数の物理ホスト構成にすることで仮想ルータ用の物理ホストが二重化され、通信不可となるリスクを低減できます。  

- 同じAnti-Affinityグループの仮想サーバを2台以上配備することで、複数の物理ホスト構成となります。  
  (Anti-Affinityグループを設定しない場合、仮想サーバは同一の物理ホストに配備される可能性があります)  
- 以下の図のように「論理的な構成図」の仮想ルータは1つですが、物理構成は右のようなイメージになります。  

![](./images/vrouter_gen2.png)


- 物理ホストAダウン → 仮想サーバ1のみに影響
- 物理ホストBダウン → 仮想サーバ2のみに影響


---

### 2. ロードバランサー


---

#### 旧リージョン

ロードバランサーは負荷分散構成となっており、DNSラウンドロビンで通信を振り分けます。  

![](./images/lbaas_gen1_1.png)


ロードバランサーがダウンした場合、稼働中のロードバランサーで運用を継続しますが、障害ロードバランサーに振り分けられる通信はエラーとなります。  

![](./images/lbaas_gen1_2.png)



---

#### 新リージョン

ロードバランサーはアクティブ・スタンバイ構成となっています。  
![](./images/lbaas_gen2_1.png)

　　　![](./images/arrow.png)

![](./images/lbaas_gen2_2.png)

ロードバランサーがダウンした場合、別のロードバランサーに自動的に切り替わります。  
切替時間は約30秒です。  


---
